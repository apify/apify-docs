name: OpenAPI checks

on:
    pull_request:
    push:
        branches:
            - master

jobs:
    lint-check:
        name: Lint check
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v6

            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 24
                  cache: "npm"
                  cache-dependency-path: "package-lock.json"

            - name: Enable corepack
              run: corepack enable

            - name: Install Dependencies
              run: npm ci --force
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Redocly lint check
              run: npm run openapi:lint:redocly -- --format=github-actions

            - name: Spectral lint check
              run: npm run openapi:lint:spectral -- --format=github-actions

            - name: YAML lint check
              run: npm run openapi:lint:yaml

    build:
        name: Build OpenAPI bundles
        runs-on: ubuntu-latest
        needs: lint-check
        steps:
            - uses: actions/checkout@v6

            - name: Use Node.js 24
              uses: actions/setup-node@v6
              with:
                  node-version: 24
                  cache: "npm"
                  cache-dependency-path: "package-lock.json"

            - name: Enable corepack
              run: corepack enable

            - name: Install Dependencies
              run: npm ci --force
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Build OpenAPI bundles
              run: npm run openapi:build

            - name: Upload bundled specification
              uses: actions/upload-artifact@v4
              with:
                  name: openapi-bundles
                  path: |
                      static/api/openapi.json
                      static/api/openapi.yaml
                  retention-days: 1

    validate:
        name: Validate bundled specification
        runs-on: ubuntu-latest
        needs: [lint-check, build]
        steps:
            - uses: actions/checkout@v6

            - name: Download bundled specification
              uses: actions/download-artifact@v4
              with:
                  name: openapi-bundles
                  path: static/api/

            - name: Validate JSON structure
              run: |
                  if ! jq empty static/api/openapi.json; then
                    echo "Invalid JSON structure in openapi.json"
                    exit 1
                  fi
                  echo "✓ JSON structure is valid"

            - name: Validate YAML structure
              run: |
                  pip install yamllint
                  if ! yamllint -d relaxed static/api/openapi.yaml; then
                    echo "Invalid YAML structure in openapi.yaml"
                    exit 1
                  fi
                  echo "✓ YAML structure is valid"

            - name: Check bundle sizes
              run: |
                  JSON_SIZE=$(stat -f%z static/api/openapi.json 2>/dev/null || stat -c%s static/api/openapi.json)
                  YAML_SIZE=$(stat -f%z static/api/openapi.yaml 2>/dev/null || stat -c%s static/api/openapi.yaml)
                  echo "Bundle sizes:"
                  echo "  JSON: $JSON_SIZE bytes"
                  echo "  YAML: $YAML_SIZE bytes"
                  if [ "$JSON_SIZE" -lt 1000 ] || [ "$YAML_SIZE" -lt 1000 ]; then
                    echo "Error: Bundle files are suspiciously small"
                    exit 1
                  fi
